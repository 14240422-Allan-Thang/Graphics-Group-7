<html>
<head>
    <title>Chess Project</title>
</head>

<style>
    body {margin: 0;}
    canvas {width: 100%; height: 100%}
</style>

<body>
    <script src="js/three.js"> </script>
    <script src="js/OrbitControls.js"> </script>
    <script src="js/PLYLoader.js"></script>

    <style>
        body {
            font-family: Monospace;
            background-color: #000;
            color: #fff;
            margin: 0px;
            overflow: hidden;
        }
        #info {
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
        }
    </style>

    <dic>
        <p>Chess Project</p>
    </dic>

    <script>
        
        var scene, camera, renderer;

        init();
        animate();
        
        function init() {
            
            // scene
            scene = new THREE.Scene();

            // renderer
            renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            
            // camera
            var ratio = window.innerWidth/window.innerHeight;
            camera = new THREE.PerspectiveCamera(45,ratio,0.1,1000);
            camera.position.set(0,0,20);
            camera.lookAt(0,0,1);

            // resize
            window.addEventListener('resize', function() {
                renderer.setSize(window.innerWidth, window.innerHeight);
                camera.aspect = window.innerWidth, window.innerHeight;
                camera.updateProjectionMatrix();
            });

            // lights
            var light = new THREE.PointLight(new THREE.Color(1,1,1), 0.5);
            camera.add(light)
            scene.add(light);

            // ambient
            
            // geometry
            var plane_geometry = new THREE.PlaneGeometry(10, 10);
            // var plane_material = new THREE.MeshBasicMaterial ({
            //     color: new THREE.Color(0x0000ff),
            //     transparent: false,
            //     opacity: 0.85,
            //     side: THREE.DoubleSide,
            // })
            // plane = new THREE.Mesh(plane_geometry, plane_material);
            // scene.add(plane);

            CreateBoard();

            //controls
            controls = new THREE.OrbitControls( camera, renderer.domElement );

            //axes. uncomment below line to show axes
            scene.add(new THREE.AxesHelper(20));

            var string = "1. e4 e5 2. Bc4 Nc6 3. Qh5 Nf6 4. Qxf7#";
            var KasparovVsTopalov = "1. e4 e5 2. Bc4 Nc6 3. Qh5 Nf6 4. Qxf7#"

            pgn = StorePGN(string);

            StartGame(pgn);

        }

        function CreateBoard() {
            var tileGeometry = new THREE.BoxGeometry(1, 0.1, 1);
            var blackTileMaterial = new THREE.MeshBasicMaterial ({color: new THREE.Color(0x000000)});
            var whiteTileMaterial = new THREE.MeshBasicMaterial ({color: new THREE.Color(0xffffff)});

            board = new THREE.Group();

            for (let i = 0; i < 8; i++) {
                for (let j = 0; j < 8; j++) {
                    var tile;
                    if (j % 2) {
                        tile = new THREE.Mesh(tileGeometry, i % 2 ? blackTileMaterial : whiteTileMaterial);
                    }
                    else {
                        tile = new THREE.Mesh(tileGeometry, i % 2 ? whiteTileMaterial : blackTileMaterial);
                    }
                    tile.position.set(i, 0, j);
                    board.add(tile);
                }
            }
            
            scene.add(board);
        }

        function AddPiece(pos) {
            // Create piece, add to scene, shoudln't need to return anything.
            return;
        }

        // animation loop
        function animate() {
            renderer.render(scene, camera);
            controls.update();
            requestAnimationFrame(animate);
        }

        function StorePGN(pgn) {
            // "1. e4 Nf6 2. f3 e5" becomes [1., e4, Nf6, 2., f3, e5]
            var moveArray;
            moveArray = pgn.split(/\s+/);
            return moveArray;
        }

        function StartGame(pgnArray) {
            for (var i = 0; i < pgnArray.length; i++) {
                // ignore the 1., 2. elements
                var colour = "white";
                if (i % 3 == 0|| i == 0) continue;

                // CheckCommand(pgnArray[i], colour);
                colour = (colour == "white") ? "black": "white";
            }
        }

        function CheckCommand(command, colour) {
            // Check Contains (+: Check, #: Checkmate, 0-0-0: Castle Queen, 0-0: Castle King, =: Promote pawn, x: takes)
            if (command.includes('+')) {
                // Handle Check
                // Find King
                // Highlight King Tile
                console.log("Check");
            }
            else if (command.includes('#')) {
                // Handle Checkmate
                // Find King
                // Highlight King Tile
                // New Text for checkmate
                console.log("Checkmate");
            }
            
            if (command.includes("0-0-0")) {
                // Handle Castle Queen
                // Find 
                console.log("Queen side Castle");
            }
            else if (command.includes("0-0")) {
                // Handle Castle King
                console.log("King Side Castle");
            }

            if (command.includes('=')) {
                // Handle Promote Pawn
                console.log("Pawn promoted");
            }
            
            if (command.includes('x')) {
                // Handle Takes
                console.log("Piece Taken");
            }

            var target = LookForPiece(command, colour);
            var destX;
            var destY; 
                // do something
            // if doesn't contain, only move piece 
            // Check Contains UpperCase (N: Knight, B: Bishop, R:Rook, Q: Queen, K: King)
                // Look for piece
            // if doesn't contain, move pawn
            // if pawn takes empty tile, remove pawn in tile below white/above black
            MovePiece(target, destX, destY);
            return;
        }

        // Change this if you find a better way.
        function LookForPiece(command, colour) {
            if (!command.includes('x')) {
                if (command.includes('N')) {
                    FindKnight(command, colour);
                }
                else if (command.includes('B')) {
                    FindBishop(command, colour);
                }
                else if (command.includes('R')) {
                    FindRook(command, colour);
                }
                else if (command.includes('Q')) {
                    FindQueen(command, colour);
                }
                else if (command.includes('K')) {
                    FindKing(command, colour);
                }
            }
            FindPawn()
        }

        function FindKnight(command, colour) {
            // Find and return the Knight to move
            return;
        }

        function FindBishop(command, colour) {
            // Find and return the Bishop to move
            return;
        }

        function FindRook(command, colour) {
            // Find and return the Rook to move
            return;
        }
        
        function FindQueen(command, colour) {
            // Find and return the Queen to move
            return;
        }

        function FindKing(command, colour) {
            // Find and return the King to move
            return;
        }

        function FindPawn(command, colour) {
            // Find and return the Pawn to move
            return;
        }

        function MovePiece(target, destinationX, destinationY) {
            // Move a piece, don't need to return anything;
            return;
        }

    </script>
</body>
</html>