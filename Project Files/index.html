<html>
<head>
    <title>Chess Project</title>
</head>

<style>
    body {margin: 0;}
    canvas {width: 100%; height: 100%}
</style>

<body>
    <script src="js/three.js"> </script>
    <script src="js/OrbitControls.js"> </script>
    <script src="js/PLYLoader.js"></script>

    <style>
        body {
            font-family: Monospace;
            background-color: #000;
            color: #fff;
            margin: 0px;
            overflow: hidden;
        }
        #info {
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
        }
    </style>

    <dic>
        <p>Chess Project</p>
    </dic>

    <script>
        
        var scene, camera, renderer;
        var board;

        init();
        animate();
        
        function init() {
            
            // scene
            scene = new THREE.Scene();

            // renderer
            renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            
            // camera
            var ratio = window.innerWidth/window.innerHeight;
            camera = new THREE.PerspectiveCamera(45,ratio,0.1,1000);
            camera.position.set(0,0,20);
            camera.lookAt(0,0,1);

            // resize
            window.addEventListener('resize', function() {
                renderer.setSize(window.innerWidth, window.innerHeight);
                camera.aspect = window.innerWidth, window.innerHeight;
                camera.updateProjectionMatrix();
            });

            // lights
            var light = new THREE.PointLight(new THREE.Color(1,1,1), 0.5);
            camera.add(light);
            scene.add(light);

            // ambient
            
            // geometry
            var plane_geometry = new THREE.PlaneGeometry(10, 10);
            // var plane_material = new THREE.MeshBasicMaterial ({
            //     color: new THREE.Color(0x0000ff),
            //     transparent: false,
            //     opacity: 0.85,
            //     side: THREE.DoubleSide,
            // })
            // plane = new THREE.Mesh(plane_geometry, plane_material);
            // scene.add(plane);

            CreateBoard();
            
            //controls
            controls = new THREE.OrbitControls( camera, renderer.domElement );

            //axes. uncomment below line to show axes
            scene.add(new THREE.AxesHelper(20));
            
            var string = "1. e4 e5 2. Bc4 Nc6 3. Qh5 Nf6 4. Qxf7#";
            var KasparovVsTopalov = "1. e4 e5 2. Bc4 Nc6 3. Qh5 Nf6 4. Qxf7#"
            
            pgn = StorePGN(string);
            
            StartGame(pgn);

        }

        function CreateBoard() {
            var tileGeometry = new THREE.BoxGeometry(1, 0.1, 1);
            var blackTileMaterial = new THREE.MeshBasicMaterial ({color: new THREE.Color(0x000000)});
            var whiteTileMaterial = new THREE.MeshBasicMaterial ({color: new THREE.Color(0xffffff)});

            const Board = {
                tilemap: [],
            };

            board = Board;
            board.tilemap = new Array(8);
            for (let i = 0; i < 8; i++) {
                board.tilemap[i] = new Array(8);
            }

            class Tile {
                constructor(file, rank) {
                    this.file = file;
                    this.rank = rank;
                    this.colour;
                    this.piece;
                    this.mesh;
                }
                getColour() {
                    return this.colour;
                }
                setColour(value) {
                    this.colour = value;
                }
                getRank() {
                    return this.rank;
                }
                setRank(value) {
                    this.rank = value;
                }
                getFile() {
                    return this.file;
                }
                setFile(value) {
                    this.file = value;
                }
                getPiece() {
                    return this.piece;
                }
                setPiece(value) {
                    this.piece = value;
                }
                getMesh() {
                    return this.mesh;
                }
                setMesh(value) {
                    this.mesh = value;
                }
            }

            class Piece {
                constructor(type, tile) {
                    this.type = type;
                    this.tile = tile;
                    this.colour;
                    this.mesh;
                }
                getType() {
                    return this.type;
                }
                getTile() {
                    return this.tile;
                }
                setTile(value) {
                    this.tile = value;
                }
                getColour() {
                    return this.colour;
                }
                setColour(value) {
                    this.colour = value;
                }
                getMesh() {
                    return this.mesh;
                }
                setMesh(value) {
                    this.mesh = value;
                }
            }

            class TakenPieces {
                constructor(colour) {
                    this.colour = colour;
                    this.pieces = [];
                }
                getPieces() {
                    return this.pieces;
                }
                setPieces(value) {
                    this.pieces = value;
                }
                addPiece(value) {
                    this.pieces.push(value);
                }
            }

            for (let i = 0; i < 8; i++) {
                for (let j = 0; j < 8; j++) {
                    let tile = new Tile(PosToFile(i), PosToRank(j));
                    var colour;
                    if (j % 2) {
                        colour = (i % 2) ? "black" : "white";
                        tile.setMesh(new THREE.Mesh(tileGeometry, colour.includes("black") ? blackTileMaterial : whiteTileMaterial));
                    }
                    else {
                        colour = (i % 2) ? "white" : "black";
                        tile.setMesh(new THREE.Mesh(tileGeometry, colour.includes("white") ? whiteTileMaterial : blackTileMaterial));
                    }
                    tile.getMesh().position.set(i, 0, j);
                    // FindTile(currentFile, currentRank).getPiece().tile = FindTile(newFile, newRank);
                    tile.setColour(colour);
                    board.tilemap[i][j] = tile;
                    scene.add(tile.getMesh());
                }
            }
        }

        function RankToPos(rank) {
            var ranks = ['a','b','c','d','e','f','g','h'];
            return ranks.indexOf(rank);
        }

        function FileToPos(file) {
            return --file;
        }

        function PosToRank(pos) {
            var ranks = ['a','b','c','d','e','f','g','h'];
            return ranks[pos];
        }

        function PosToFile(pos) {
            return ++pos;
        }

        function FindTile(rank, file) {
            return board.tilemap[RankToPos(rank)][FileToPos(file)];
        }

        function AddPiece(pos) {
            // Create piece, add to scene, shoudln't need to return anything.
            return;
        }

        // animation loop
        function animate() {
            renderer.render(scene, camera);
            controls.update();
            requestAnimationFrame(animate);
        }

        function StorePGN(pgn) {
            // "1. e4 Nf6 2. f3 e5" becomes [1., e4, Nf6, 2., f3, e5]
            var moveArray;
            moveArray = pgn.split(/\s+/);
            return moveArray;
        }

        function StartGame(pgnArray) {
            for (var i = 0; i < pgnArray.length; i++) {
                // ignore the 1., 2. elements
                var colour = "white";
                if (i % 3 == 0|| i == 0) continue;

                DoCommand(pgnArray[i], colour);
                colour = (colour.includes("white")) ? "black": "white";
            }
        }

        function DoCommand(command, colour) {
            // Check Contains (+: Check, #: Checkmate, 0-0-0: Castle Queen, 0-0: Castle King, =: Promote pawn, x: takes)
            if (command.includes('+')) {
                // Handle Check
                DoCheck(colour);
                // Remove '+'
                command = command.replace('+', '');
                // Call CheckCommand again
                DoCommand(command, colour);
                // Return so that DoBasicCommand() isn't called twice
                return;
            }
            else if (command.includes('#')) {
                // Handle Checkmate
                DoCheckMate(colour);
                // Remove '#'
                command = command.replace('#', '');
                // Call CheckCommand again
                DoCommand(command, colour);
                // Return
                return;
            }
            
            if (command.includes("0-0-0")) {
                // Handle Castle Queen
                DoCastleQueen(colour);
                // Return
                return;
            }
            else if (command.includes("0-0")) {
                // Handle Castle King
                DoCastleKing(colour);
                // Return
                return;
            }

            if (command.includes('=')) {
                // Handle Promote Pawn
                DoPromotePawn(command, colour);
                // Remove '=' and last char
                command = command.slice(0, command.length - 2);
                // Call CheckCommand again
                DoCommand(command, colour);
                // Return
                return;
            }
            
            if (command.includes('x')) {
                // Handle Takes
                // Remove Piece at pos of last 2 char
                let takenTile = FindTile(command.charAt(command.length - 2), command.charAt(command.length - 1));
                DoTakePiece(colour, takenTile);
                // Remove 'x'
                command = command.replace('x', '');
                // Call CheckCommand again
                DoCommand(command, colour);
                // Return
                return;
            }

            DoBasicCommand(command, colour);
        }

        function DoCheck(colour) {
            return;
            var kingPiece;
            var highlightColour;
            if (colour.includes("white")) {
                // Look for black King tile
                kingPiece = LookForPiece("K", "black");
                let kingTile = kingPiece.tile;
                // Highlight King tile
                kingTile.mesh.colour = highlightColour;
            }
            else {
                // Look for white King
                kingPiece = LookForPiece("K", "white");
                let kingTile = kingPiece.tile;
                // Highlight King tile
                kingTile.mesh.colour = highlightColour;
            }
        }

        function DoCheckMate(colour) {
            DoCheck(colour);
            // new Text to say checkmate;
        }

        function DoCastleQueen(colour) {
            var kingPiece;
            var rookPiece;
            // if white
            if (colour.includes("white")) {
                // Find King
                kingPiece = FindTile('e', 1).piece;
                // Find Rook
                rookPiece = FindTile('a', 1).piece;
                // Move King 2 Left
                MovePiece(kingPiece, 'c', 1);
                // Move Rook 3 Right
                MovePiece(rookPiece, 'd', 1);
            }
            else {
                kingPiece = FindTile('e', 8).piece;
                rookPiece = FindTile('a', 8).piece;
                MovePiece(kingPiece, 'c', 8);
                MovePiece(rookPiece, 'd', 8);
            }
        }
        
        function DoCastleKing(colour) {
            var kingPiece;
            var rookPiece;
            // if white
            if (colour.includes("white")) {
                // Find King
                kingPiece = FindTile('e', 1).piece;
                // Find Rook
                rookPiece = FindTile('h', 1).piece;
                // Move King 2 Right
                MovePiece(kingPiece, 'g', 1);
                // Move Rook 3 Left
                MovePiece(rookPiece, 'f', 1);
            }
            else {
                kingPiece = FindTile('e', 8).piece;
                rookPiece = FindTile('h', 8).piece;
                MovePiece(kingPiece, 'g', 8);
                MovePiece(rookPiece, 'f', 8);
            }
        }

        function DoPromotePawn(command, colour) {
            let newPieceType = command.charAt(command.length - 1);
            var rank;
            if (colour.includes("white")) {
                rank = 7;
            }
            else {
                rank = 2;
            }
            let file = command.charAt(0);
            let pawnTile = FindTile(rank, file);
            // Remove Pawn
            scene.remove(pawnTile.piece.mesh);
            // Add new Piece depending on last letter
            AddPiece(newPieceType, rank, file);
        }

        function DoTakePiece(colour, takenTile) {
            return; // REMOVE THIS WHEN DONE
            // Remove piece at takenTile
            // Move it to TakenPieces of same colour
            takenTile.getPiece().getMesh().position.set(10,0,0);
        }

        function DoBasicCommand(command, colour) {
            // endRank/y-axis = last char
            var endRank = command.charAt(command.length - 1);
            // endFile/x-axis = 2nd last char
            var endFile = command.charAt(command.length - 2);

            // target = piece to move
            var target;

            // if 2 char -- e4
            if (command.length == 2) {
                var tile; 
                // Look for Pawn
                // Set target to Pawn
                if (colour.includes("white")) {
                    target = FindTile(endFile.toString(), (endRank - 1)).piece;
                }
                else {
                    target = FindTile('endFile', (endRank + 1)).piece;
                }
            }
            // if 3 char -- Qe4
            else if (command.length == 3) {
                // Look for piece of type 1st char
                // Type of piece is specified in first char as UpperCase
                var type = command.charAt(0);
                if (IsUpperCase(type)) {
                    target = LookForPiece(type, colour);
                }
                // If type is not UpperCase, type must be pawn and file is specified
                else {
                    target = LookForPiece();
                }
            }
            // if 4 char -- Qde4/Q3e4
            else if (command.length == 4) {
                // Look for piece of type 1st char on 2nd char rank/file
                var disambiguator = command.charAt(1);
                // If 2nd character is a a-h, find piece on that file
                if ((/[a-h]/).test(disambiguator)) {
                    var file = disambiguator;
                }
                // Else 2nd character is 1-8. find piece on that rank
                else {
                    var rank = disambiguator;
                }
                target = LookForPiece();
            }
            // if 5 char -- Qd3e4
            else {
                // Look for piece at position (2nd, 3rd)
                // Move piece to destination
                var file = command.charAt(1);
                var rank = command.charAt(2);
                target = FindTile(file, rank).getPiece();
            }
            
            MovePiece(target, endFile, endRank);
        }

        function IsUpperCase(str) {
            if (str.toUpperCase() === str) return true;
            return false;
        }

        // This function will always be called with both type paramanter as a single upper-case character eg, "R"
        // and colour paramater as a string, either "white" or "black"
        // Function should return the reference to the piece.

        //RANK = x = j
        //FILE = y = i

        
        function LookForPiece(type, colour, rankToMove, fileToMove, rankPieceAt, filePieceAt, pawnCapture) {
            // if colour.incldes("white") 
            // Look for white piece
            // else
            // look for black piece

            const rankLook = ["a", "b", "c", "d", "e", "f", "g", "h"];
            const fileLook = [1, 2, 3, 4, 5, 6, 7, 8];

            switch (type) {
                case 'K':

                    let kStr1 = colour;
                    let kStr2 = "King";
                    let kStr3 = kStr1.concat(kStr2);

                    return scene.getObjectByName(kStr3);

                    break;
                case 'Q':

                    queenFound = false;

                    while (!queenFound)
                    {

                        let rankPos;
                        let filePos;

                        for (let i = 0; i < 8; i++)
                        {
                            if (rankToMove == rankLook[i])
                                rankPos = i;
                        }

                        filePos = fileToMove;

                        let pieceFound = false;
                        let tempRankPos;
                        let tempFilePos;

                        //LEFT DIRECTION
                        while (!pieceFound)
                        {
                            tempRankPos = rankPos;

                            for (let i = 0; i < 7; i++)
                            {
                                if (tempRankPos - 1 > -1)
                                    tempRankPos--;
                                    if (board.tilemap[filePos][tempRankPos].getPiece.getType = queen && board.tilemap[filePos][tempRankPos].getPiece.getColour == colour)
                                        if (!rankPieceAt == null)
                                            if (rankPieceAt == tempRankPos)
                                                pieceFound = true; i = 7;
                                                return board.tilemap[filePos][tempRankPos].getPiece;
                                        if (rankPieceAt == null)
                                            pieceFound = true; i = 7;
                                            return board.tilemap[filePos][tempRankPos].getPiece;
                                    if (!board.tilemap[filePos][tempRankPos].getPiece == null)
                                        i = 7;
                                    
                            }
                        }

                        //RIGHT DIRECTION
                        while (!pieceFound)
                        {
                            tempRankPos = rankPos;

                            for (let i = 0; i < 7; i++)
                            {
                                if (tempRankPos + 1 < 8)
                                    tempRankPos++;
                                    if (board.tilemap[filePos][tempRankPos].getPiece.getType = queen && board.tilemap[filePos][tempRankPos].getPiece.getColour == colour)
                                        if (!rankPieceAt == null)
                                            if (rankPieceAt == tempRankPos)
                                                pieceFound = true; i = 7;
                                                return board.tilemap[filePos][tempRankPos].getPiece;
                                        if (rankPieceAt == null)
                                            pieceFound = true; i = 7;
                                            return board.tilemap[filePos][tempRankPos].getPiece;
                                    if (!board.tilemap[filePos][tempRankPos].getPiece == null)
                                        i = 7;
                                    
                            }
                        }

                        //UP DIRECTION
                        while (!pieceFound)
                        {
                            tempFilePos = filePos;

                            for (let i = 0; i < 7; i++)
                            {
                                if (tempFilePos + 1 < 9)
                                    tempFilePos++;
                                    if (board.tilemap[tempFilePos][rankPos].getPiece.getType = queen && board.tilemap[tempFilePos][rankPos].getPiece.getColour == colour)
                                        if (!filePieceAt == null)
                                            if (filePieceAt == tempFilePos)
                                                pieceFound = true; i = 7;
                                                return board.tilemap[tempFilePos][rankPos].getPiece;
                                        if (filePieceAt == null)
                                            pieceFound = true; i = 7;
                                            return board.tilemap[tempFilePos][rankPos].getPiece;
                                    if (!board.tilemap[tempFilePos][rankPos].getPiece == null)
                                        i = 7;
                                    
                            }
                        }

                        //DOWN DIRECTION
                        while (!pieceFound)
                        {
                            tempFilePos = filePos;

                            for (let i = 0; i < 7; i++)
                            {
                                if (tempFilePos - 1 > 0)
                                    tempFilePos--;
                                    if (board.tilemap[tempFilePos][rankPos].getPiece.getType = queen && board.tilemap[tempFilePos][rankPos].getPiece.getColour == colour)
                                        if (!filePieceAt == null)
                                            if (filePieceAt == tempFilePos)
                                                pieceFound = true; i = 7;
                                                return board.tilemap[tempFilePos][rankPos].getPiece;
                                        if (filePieceAt == null)
                                            pieceFound = true; i = 7;
                                            return board.tilemap[tempFilePos][rankPos].getPiece;
                                    if (!board.tilemap[tempFilePos][rankPos].getPiece == null)
                                        i = 7;
                                    
                            }
                        }  
                        
                        //UP-LEFT
                        while (!pieceFound)
                        {
                            tempFilePos = filePos;
                            tempRankPos = rankPos;

                            for (let i = 0; i < 7; i++)
                            {
                                if (tempFilePos + 1 < 9 && tempRankPos - 1 > -1)
                                    tempFilePos++;
                                    tempRankPos--;
                                    if (board.tilemap[tempFilePos][tempRankPos].getPiece.getType = queen && board.tilemap[tempFilePos][tempRankPos].getPiece.getColour == colour)
                                        if (!filePieceAt == null)
                                            if (filePieceAt == tempFilePos)
                                                pieceFound = true; i = 7;
                                                return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                        if (!rankPieceAt == null)
                                            if (rankPieceAt == tempRankPos)
                                                pieceFound = true; i = 7;
                                                return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                        if (filePieceAt == null)
                                            pieceFound = true; i = 7;
                                            return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                    if (!board.tilemap[tempFilePos][rankPos].getPiece == null)
                                        i = 7;
                                    
                            }                                
                        }

                        //UP-RIGHT
                        while (!pieceFound)
                        {
                            tempFilePos = filePos;
                            tempRankPos = rankPos;

                            for (let i = 0; i < 7; i++)
                            {
                                if (tempFilePos + 1 < 9 && tempRankPos + 1 < 8)
                                    tempFilePos++;
                                    tempRankPos++;
                                    if (board.tilemap[tempFilePos][tempRankPos].getPiece.getType = queen && board.tilemap[tempFilePos][tempRankPos].getPiece.getColour == colour)
                                        if (!filePieceAt == null)
                                            if (filePieceAt == tempFilePos)
                                                pieceFound = true; i = 7;
                                                return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                        if (!rankPieceAt == null)
                                            if (rankPieceAt == tempRankPos)
                                                pieceFound = true; i = 7;
                                                return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                        if (filePieceAt == null)
                                            pieceFound = true; i = 7;
                                            return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                    if (!board.tilemap[tempFilePos][rankPos].getPiece == null)
                                        i = 7;
                                    
                            }                                
                        }

                        //DOWN-LEFT
                        while (!pieceFound)
                        {
                            tempFilePos = filePos;
                            tempRankPos = rankPos;

                            for (let i = 0; i < 7; i++)
                            {
                                if (tempFilePos - 1 > 0 && tempRankPos - 1 > -1)
                                    tempFilePos--;
                                    tempRankPos--;
                                    if (board.tilemap[tempFilePos][tempRankPos].getPiece.getType = queen && board.tilemap[tempFilePos][tempRankPos].getPiece.getColour == colour)
                                        if (!filePieceAt == null)
                                            if (filePieceAt == tempFilePos)
                                                pieceFound = true; i = 7;
                                                return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                        if (!rankPieceAt == null)
                                            if (rankPieceAt == tempRankPos)
                                                pieceFound = true; i = 7;
                                                return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                        if (filePieceAt == null)
                                            pieceFound = true; i = 7;
                                            return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                    if (!board.tilemap[tempFilePos][rankPos].getPiece == null)
                                        i = 7;
                                    
                            }                                
                        }

                        //DOWN-RIGHT
                        while (!pieceFound)
                        {
                            tempFilePos = filePos;
                            tempRankPos = rankPos;

                            for (let i = 0; i < 7; i++)
                            {
                                if (tempFilePos - 1 > 0 && tempRankPos + 1 < 8)
                                    tempFilePos--;
                                    tempRankPos++;
                                    if (board.tilemap[tempFilePos][tempRankPos].getPiece.getType = queen && board.tilemap[tempFilePos][tempRankPos].getPiece.getColour == colour)
                                        if (!filePieceAt == null)
                                            if (filePieceAt == tempFilePos)
                                                pieceFound = true; i = 7;
                                                return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                        if (!rankPieceAt == null)
                                            if (rankPieceAt == tempRankPos)
                                                pieceFound = true; i = 7;
                                                return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                        if (filePieceAt == null)
                                            pieceFound = true; i = 7;
                                            return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                    if (!board.tilemap[tempFilePos][rankPos].getPiece == null)
                                        i = 7;
                                    
                            }                                
                        }

                        queenFound = true;
                    }                 

                    break;
                case 'R':
        
                        let rankPos;
                        let filePos;

                        for (let i = 0; i < 8; i++)
                        {
                            if (rankToMove == rankLook[i])
                                rankPos = i;
                        }

                        filePos = fileToMove;

                        let pieceFound = false;
                        let tempRankPos;
                        let tempFilePos;

                        //LEFT DIRECTION
                        while (!pieceFound)
                        {
                            tempRankPos = rankPos;

                            for (let i = 0; i < 7; i++)
                            {
                                if (tempRankPos - 1 > -1)
                                    tempRankPos--;
                                    if (board.tilemap[filePos][tempRankPos].getPiece.getType = rook && board.tilemap[filePos][tempRankPos].getPiece.getColour == colour)
                                        if (!rankPieceAt == null)
                                            if (rankPieceAt == tempRankPos)
                                                pieceFound = true; i = 7;
                                                return board.tilemap[filePos][tempRankPos].getPiece;
                                        if (rankPieceAt == null)
                                            pieceFound = true; i = 7;
                                            return board.tilemap[filePos][tempRankPos].getPiece;
                                    if (!board.tilemap[filePos][tempRankPos].getPiece == null)
                                        i = 7;
                                    
                            }
                        }

                        //RIGHT DIRECTION
                        while (!pieceFound)
                        {
                            tempRankPos = rankPos;

                            for (let i = 0; i < 7; i++)
                            {
                                if (tempRankPos + 1 < 8)
                                    tempRankPos++;
                                    if (board.tilemap[filePos][tempRankPos].getPiece.getType = rook && board.tilemap[filePos][tempRankPos].getPiece.getColour == colour)
                                        if (!rankPieceAt == null)
                                            if (rankPieceAt == tempRankPos)
                                                pieceFound = true; i = 7;
                                                return board.tilemap[filePos][tempRankPos].getPiece;
                                        if (rankPieceAt == null)
                                            pieceFound = true; i = 7;
                                            return board.tilemap[filePos][tempRankPos].getPiece;
                                    if (!board.tilemap[filePos][tempRankPos].getPiece == null)
                                        i = 7;
                                    
                            }
                        }

                        //UP DIRECTION
                        while (!pieceFound)
                        {
                            tempFilePos = filePos;

                            for (let i = 0; i < 7; i++)
                            {
                                if (tempFilePos + 1 < 9)
                                    tempFilePos++;
                                    if (board.tilemap[tempFilePos][rankPos].getPiece.getType = rook && board.tilemap[tempFilePos][rankPos].getPiece.getColour == colour) 
                                        if (!filePieceAt == null)
                                            if (filePieceAt == tempFilePos)
                                                pieceFound = true; i = 7;
                                                return board.tilemap[tempFilePos][rankPos].getPiece;
                                        if (filePieceAt == null)
                                            pieceFound = true; i = 7;
                                            return board.tilemap[tempFilePos][rankPos].getPiece;
                                    if (!board.tilemap[tempFilePos][rankPos].getPiece == null)
                                        i = 7;
                                    
                            }
                        }

                        //DOWN DIRECTION
                        while (!pieceFound)
                        {
                            tempFilePos = filePos;

                            for (let i = 0; i < 7; i++)
                            {
                                if (tempFilePos - 1 > 0)
                                    tempFilePos--;
                                    if (board.tilemap[tempFilePos][rankPos].getPiece.getType = rook && board.tilemap[tempFilePos][rankPos].getPiece.getColour == colour)
                                        if (!filePieceAt == null)
                                            if (filePieceAt == tempFilePos)
                                                pieceFound = true; i = 7;
                                                return board.tilemap[tempFilePos][rankPos].getPiece;
                                        if (filePieceAt == null)
                                            pieceFound = true; i = 7;
                                            return board.tilemap[tempFilePos][rankPos].getPiece;
                                    if (!board.tilemap[tempFilePos][rankPos].getPiece == null)
                                        i = 7;
                                    
                            }
                        }

                    break;
                case 'N':

                    let pieceAtTile = false;
                    
                    while (!pieceAtTile)
                    {

                        let rankPos;
                        let filePos;

                        for (let i = 0; i < 8; i++)
                        {
                            if (rankToMove == rankLook[i])
                                rankPos = i;
                        }

                        filePos = fileToMove;

                        //LEFT-UP
                        if (rankpos - 2 > -1 && filePos + 1 < 9) 
                            if (board.tilemap[filePos + 1][rankLook - 2].getPiece.getType = knight && board.tilemap[filePos + 1][rankLook - 2].getPiece.getColour == colour)
                                if (!rankPieceAt == null)
                                    if (board.tilemap[filePos + 1][rankLook - 2].getRank = rankPieceAt)
                                        return board.tilemap[filePos + 1][rankLook - 2].getPiece;
                                if (!filePieceAt == null)
                                    if (board.tilemap[filePos + 1][rankLook - 2].getFile = filePieceAt)
                                        return board.tilemap[filePos + 1][rankLook - 2].getPiece;                           
                                if (rankPieceAt == null && filePieceAt == null)
                                    return board.tilemap[filePos + 1][rankLook - 2].getPiece;

                        //LEFT-DOWN
                        if (rankpos - 2 > -1 && filePos - 1 > 0) 
                            if (board.tilemap[filePos - 1][rankLook - 2].getPiece.getType = knight && board.tilemap[filePos - 1][rankLook - 2].getPiece.getColour == colour)
                                if (!rankPieceAt == null)
                                    if (board.tilemap[filePos - 1][rankLook - 2].getRank = rankPieceAt)
                                        return board.tilemap[filePos - 1][rankLook - 2].getPiece;
                                if (!filePieceAt == null)
                                    if (board.tilemap[filePos - 1][rankLook - 2].getFile = filePieceAt)
                                        return board.tilemap[filePos - 1][rankLook - 2].getPiece;                           
                                if (rankPieceAt == null && filePieceAt == null)
                                    return board.tilemap[filePos - 1][rankLook - 2].getPiece;
 
                        //RIGHT-UP
                        if (rankpos + 2 < 8 && filePos + 1 < 9) 
                            if (board.tilemap[filePos + 1][rankLook + 2].getPiece.getType = knight && board.tilemap[filePos + 1][rankLook + 2].getPiece.getColour == colour)
                                if (!rankPieceAt == null)
                                    if (board.tilemap[filePos + 1][rankLook + 2].getRank = rankPieceAt)
                                        return board.tilemap[filePos + 1][rankLook + 2].getPiece;
                                if (!filePieceAt == null)
                                    if (board.tilemap[filePos + 1][rankLook + 2].getFile = filePieceAt)
                                        return board.tilemap[filePos + 1][rankLook + 2].getPiece;                           
                                if (rankPieceAt == null && filePieceAt == null)
                                    return board.tilemap[filePos + 1][rankLook + 2].getPiece;
 
                        //RIGHT-DOWN
                        if (rankpos + 2 < 8 && filePos - 1 > 0) 
                            if (board.tilemap[filePos - 1][rankLook + 2].getPiece.getType = knight && board.tilemap[filePos - 1][rankLook + 2].getPiece.getColour == colour)
                                if (!rankPieceAt == null)
                                    if (board.tilemap[filePos - 1][rankLook + 2].getRank = rankPieceAt)
                                        return board.tilemap[filePos - 1][rankLook + 2].getPiece;
                                if (!filePieceAt == null)
                                    if (board.tilemap[filePos - 1][rankLook + 2].getFile = filePieceAt)
                                        return board.tilemap[filePos - 1][rankLook + 2].getPiece;                           
                                if (rankPieceAt == null && filePieceAt == null)
                                    return board.tilemap[filePos - 1][rankLook + 2].getPiece;
 
                        //UP-LEFT
                        if (rankpos - 1 > -1 && filePos + 2 < 9) 
                            if (board.tilemap[filePos + 2][rankLook - 1].getPiece.getType = knight && board.tilemap[filePos + 2][rankLook - 1].getPiece.getColour == colour)
                                if (!rankPieceAt == null)
                                    if (board.tilemap[filePos + 2][rankLook - 1].getRank = rankPieceAt)
                                        return board.tilemap[filePos + 2][rankLook - 1].getPiece;
                                if (!filePieceAt == null)
                                    if (board.tilemap[filePos + 2][rankLook - 1].getFile = filePieceAt)
                                        return board.tilemap[filePos + 2][rankLook - 1].getPiece;                           
                                if (rankPieceAt == null && filePieceAt == null)
                                    return board.tilemap[filePos + 2][rankLook - 1].getPiece;
 
                        //UP-RIGHT
                        if (rankpos + 1 < 8 && filePos + 2 < 9) 
                            if (board.tilemap[filePos + 2][rankLook + 1].getPiece.getType = knight && board.tilemap[filePos + 2][rankLook + 1].getPiece.getColour == colour)
                                if (!rankPieceAt == null)
                                    if (board.tilemap[filePos + 2][rankLook + 1].getRank = rankPieceAt)
                                        return board.tilemap[filePos + 2][rankLook + 1].getPiece;
                                if (!filePieceAt == null)
                                    if (board.tilemap[filePos + 2][rankLook + 1].getFile = filePieceAt)
                                        return board.tilemap[filePos + 2][rankLook + 1].getPiece;                           
                                if (rankPieceAt == null && filePieceAt == null)
                                    return board.tilemap[filePos + 2][rankLook + 1].getPiece;
 
                        //DOWN-LEFT
                        if (rankpos - 1 > -1 && filePos - 2 > 0) 
                            if (board.tilemap[filePos - 2][rankLook - 1].getPiece.getType = knight && board.tilemap[filePos - 2][rankLook - 1].getPiece.getColour == colour)
                                if (!rankPieceAt == null)
                                    if (board.tilemap[filePos - 2][rankLook - 1].getRank = rankPieceAt)
                                        return board.tilemap[filePos - 2][rankLook - 1].getPiece;
                                if (!filePieceAt == null)
                                    if (board.tilemap[filePos - 2][rankLook - 1].getFile = filePieceAt)
                                        return board.tilemap[filePos - 2][rankLook - 1].getPiece;                           
                                if (rankPieceAt == null && filePieceAt == null)
                                    return board.tilemap[filePos - 2][rankLook - 1].getPiece;
 
                        //DOWN-RIGHT
                        if (rankpos + 1 < 8 && filePos - 2 > 0) 
                            if (board.tilemap[filePos - 2][rankLook + 1].getPiece.getType = knight && board.tilemap[filePos - 2][rankLook + 1].getPiece.getColour == colour)
                                if (!rankPieceAt == null)
                                    if (board.tilemap[filePos - 2][rankLook + 1].getRank = rankPieceAt)
                                        return board.tilemap[filePos - 2][rankLook + 1].getPiece;
                                if (!filePieceAt == null)
                                    if (board.tilemap[filePos - 2][rankLook + 1].getFile = filePieceAt)
                                        return board.tilemap[filePos - 2][rankLook + 1].getPiece;                           
                                if (rankPieceAt == null && filePieceAt == null)
                                    return board.tilemap[filePos - 2][rankLook + 1].getPiece;
 
                        pieceAtTile = true;
                                                   
                    }

                    break;
                case 'B':

                    bishopFound = false;

                    while (!bishopFound)
                    {

                        let rankPos;
                        let filePos;

                        for (let i = 0; i < 8; i++)
                        {
                            if (rankToMove == rankLook[i])
                                rankPos = i;
                        }

                        filePos = fileToMove;

                        let pieceFound = false;
                        let tempRankPos;
                        let tempFilePos;
                            
                        //UP-LEFT
                        while (!pieceFound)
                        {
                            tempFilePos = filePos;
                            tempRankPos = rankPos;

                            for (let i = 0; i < 7; i++)
                            {
                                if (tempFilePos + 1 < 9 && tempRankPos - 1 > -1)
                                    tempFilePos++;
                                    tempRankPos--;
                                    if (board.tilemap[tempFilePos][tempRankPos].getPiece.getType = bishop && board.tilemap[tempFilePos][tempRankPos].getPiece.getColour == colour)
                                        if (!filePieceAt == null)
                                            if (filePieceAt == tempFilePos)
                                                pieceFound = true; i = 7;
                                                return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                        if (!rankPieceAt == null)
                                            if (rankPieceAt == tempRankPos)
                                                pieceFound = true; i = 7;
                                                return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                        if (filePieceAt == null)
                                            pieceFound = true; i = 7;
                                            return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                    if (!board.tilemap[tempFilePos][rankPos].getPiece == null)
                                        i = 7;
                                    
                            }                                
                        }

                        //UP-RIGHT
                        while (!pieceFound)
                        {
                            tempFilePos = filePos;
                            tempRankPos = rankPos;

                            for (let i = 0; i < 7; i++)
                            {
                                if (tempFilePos + 1 < 9 && tempRankPos + 1 < 8)
                                    tempFilePos++;
                                    tempRankPos++;
                                    if (board.tilemap[tempFilePos][tempRankPos].getPiece.getType = bishop && board.tilemap[tempFilePos][tempRankPos].getPiece.getColour == colour)
                                        if (!filePieceAt == null)
                                            if (filePieceAt == tempFilePos)
                                                pieceFound = true; i = 7;
                                                return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                        if (!rankPieceAt == null)
                                            if (rankPieceAt == tempRankPos)
                                                pieceFound = true; i = 7;
                                                return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                        if (filePieceAt == null)
                                            pieceFound = true; i = 7;
                                            return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                    if (!board.tilemap[tempFilePos][rankPos].getPiece == null)
                                        i = 7;
                                    
                            }                                
                        }

                        //DOWN-LEFT
                        while (!pieceFound)
                        {
                            tempFilePos = filePos;
                            tempRankPos = rankPos;

                            for (let i = 0; i < 7; i++)
                            {
                                if (tempFilePos - 1 > 0 && tempRankPos - 1 > -1)
                                    tempFilePos--;
                                    tempRankPos--;
                                    if (board.tilemap[tempFilePos][tempRankPos].getPiece.getType = bishop && board.tilemap[tempFilePos][tempRankPos].getPiece.getColour == colour)
                                        if (!filePieceAt == null)
                                            if (filePieceAt == tempFilePos)
                                                pieceFound = true; i = 7;
                                                return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                        if (!rankPieceAt == null)
                                            if (rankPieceAt == tempRankPos)
                                                pieceFound = true; i = 7;
                                                return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                        if (filePieceAt == null)
                                            pieceFound = true; i = 7;
                                            return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                    if (!board.tilemap[tempFilePos][rankPos].getPiece == null)
                                        i = 7;
                                    
                            }                                
                        }

                        //DOWN-RIGHT
                        while (!pieceFound)
                        {
                            tempFilePos = filePos;
                            tempRankPos = rankPos;

                            for (let i = 0; i < 7; i++)
                            {
                                if (tempFilePos - 1 > 0 && tempRankPos + 1 < 8)
                                    tempFilePos--;
                                    tempRankPos++;
                                    if (board.tilemap[tempFilePos][tempRankPos].getPiece.getType = bishop && board.tilemap[tempFilePos][tempRankPos].getPiece.getColour == colour)
                                        if (!filePieceAt == null)
                                            if (filePieceAt == tempFilePos)
                                                pieceFound = true; i = 7;
                                                return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                        if (!rankPieceAt == null)
                                            if (rankPieceAt == tempRankPos)
                                                pieceFound = true; i = 7;
                                                return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                        if (filePieceAt == null)
                                            pieceFound = true; i = 7;
                                            return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                    if (!board.tilemap[tempFilePos][rankPos].getPiece == null)
                                        i = 7;
                                    
                            }                                
                        }

                        bishopFound = true;
                    }



                    break;
                default:

                    if (colour == white)
                    {
                        let rankPos;
                        let filePos;

                        for (let i = 0; i < 8; i++)
                        {
                            if (rankToMove == rankLook[i])
                                rankPos = i;
                        }

                        filePos = fileToMove;

                        let pieceFound = false;
                        let tempRankPos;
                        let tempFilePos;

                        if (!pawnCapture)
                        {
                            while (!pieceFound)
                            {
                                tempFilePos = filePos;

                                for (let i = 1; i < 3; i++)
                                {
                                    if (tempFilePos - 1 > 0)
                                        tempFilePos--;
                                        if (board.tilemap[tempFilePos][rankPos].getPiece.getType = pawn && board.tilemap[tempFilePos][rankPos].getPiece.getColour == colour)
                                            if (!filePieceAt == null)
                                                if (filePieceAt == tempFilePos)
                                                    pieceFound = true; i = 3;
                                                    return board.tilemap[tempFilePos][rankPos].getPiece;
                                            if (filePieceAt == null)
                                                pieceFound = true; i = 3;
                                                return board.tilemap[tempFilePos][rankPos].getPiece;
                                        if (!board.tilemap[tempFilePos][rankPos].getPiece == null)
                                            i = 3;
                                        
                                }
                            }
                        }

                        if (pawnCapture)
                        {
                            //DOWN-LEFT
                            while (!pieceFound)
                            {
                                tempFilePos = filePos;
                                tempRankPos = rankPos;

                                if (tempFilePos - 1 > 0 && tempRankPos - 1 > -1)
                                    tempFilePos--;
                                    tempRankPos--;
                                    if (board.tilemap[tempFilePos][tempRankPos].getPiece.getType = pawn && board.tilemap[tempFilePos][tempRankPos].getPiece.getColour == colour)
                                        if (!filePieceAt == null)
                                            if (filePieceAt == tempFilePos)
                                                pieceFound = true; i = 7;
                                                return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                        if (!rankPieceAt == null)
                                            if (rankPieceAt == tempRankPos)
                                                pieceFound = true; i = 7;
                                                return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                        if (filePieceAt == null)
                                            pieceFound = true; i = 7;
                                            return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                    if (!board.tilemap[tempFilePos][rankPos].getPiece == null)
                                        i = 7;
                                        
                                                               
                            }

                            //DOWN-RIGHT
                            while (!pieceFound)
                            {
                                tempFilePos = filePos;
                                tempRankPos = rankPos;


                                if (tempFilePos - 1 > 0 && tempRankPos + 1 < 8)
                                    tempFilePos--;
                                    tempRankPos++;
                                    if (board.tilemap[tempFilePos][tempRankPos].getPiece.getType = pawn && board.tilemap[tempFilePos][tempRankPos].getPiece.getColour == colour)
                                        if (!filePieceAt == null)
                                            if (filePieceAt == tempFilePos)
                                                pieceFound = true; i = 7;
                                                return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                        if (!rankPieceAt == null)
                                            if (rankPieceAt == tempRankPos)
                                                pieceFound = true; i = 7;
                                                return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                        if (filePieceAt == null)
                                            pieceFound = true; i = 7;
                                            return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                    if (!board.tilemap[tempFilePos][rankPos].getPiece == null)
                                        i = 7;
                                        
                                                                
                            }
                        }
                    }

                    if (colour == black)
                    {
                        let rankPos;
                        let filePos;

                        for (let i = 0; i < 8; i++)
                        {
                            if (rankToMove == rankLook[i])
                                rankPos = i;
                        }

                        filePos = fileToMove;

                        let pieceFound = false;
                        let tempRankPos;
                        let tempFilePos;

                        if (!pawnCapture)
                        {
                            while (!pieceFound)
                            {
                                tempFilePos = filePos;

                                for (let i = 1; i < 3; i++)
                                {
                                    if (tempFilePos + 1 < 9)
                                        tempFilePos++;
                                        if (board.tilemap[tempFilePos][rankPos].getPiece.getType = pawn && board.tilemap[tempFilePos][rankPos].getPiece.getColour == colour)
                                            if (!filePieceAt == null)
                                                if (filePieceAt == tempFilePos)
                                                    pieceFound = true; i = 3;
                                                    return board.tilemap[tempFilePos][rankPos].getPiece;
                                            if (filePieceAt == null)
                                                pieceFound = true; i = 3;
                                                return board.tilemap[tempFilePos][rankPos].getPiece;
                                        if (!board.tilemap[tempFilePos][rankPos].getPiece == null)
                                            i = 3;
                                        
                                }
                            }
                        }

                        if (pawnCapture)
                        {
                            //UP-LEFT
                            while (!pieceFound)
                                {
                                    tempFilePos = filePos;
                                    tempRankPos = rankPos;

                                    if (tempFilePos + 1 < 9 && tempRankPos - 1 > -1)
                                        tempFilePos++;
                                        tempRankPos--;
                                        if (board.tilemap[tempFilePos][tempRankPos].getPiece.getType = pawn && board.tilemap[tempFilePos][tempRankPos].getPiece.getColour == colour)
                                            if (!filePieceAt == null)
                                                if (filePieceAt == tempFilePos)
                                                    pieceFound = true; i = 7;
                                                    return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                            if (!rankPieceAt == null)
                                                if (rankPieceAt == tempRankPos)
                                                    pieceFound = true; i = 7;
                                                    return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                            if (filePieceAt == null)
                                                pieceFound = true; i = 7;
                                                return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                        if (!board.tilemap[tempFilePos][rankPos].getPiece == null)
                                            i = 7;
                                            
                                                                
                                }

                                //DOWN-RIGHT
                                while (!pieceFound)
                                {
                                    tempFilePos = filePos;
                                    tempRankPos = rankPos;


                                    if (tempFilePos + 1 < 9 && tempRankPos + 1 < 8)
                                        tempFilePos++;
                                        tempRankPos++;
                                        if (board.tilemap[tempFilePos][tempRankPos].getPiece.getType = pawn && board.tilemap[tempFilePos][tempRankPos].getPiece.getColour == colour)
                                            if (!filePieceAt == null)
                                                if (filePieceAt == tempFilePos)
                                                    pieceFound = true; i = 7;
                                                    return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                            if (!rankPieceAt == null)
                                                if (rankPieceAt == tempRankPos)
                                                    pieceFound = true; i = 7;
                                                    return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                            if (filePieceAt == null)
                                                pieceFound = true; i = 7;
                                                return board.tilemap[tempFilePos][tempRankPos].getPiece;
                                        if (!board.tilemap[tempFilePos][rankPos].getPiece == null)
                                            i = 7;
                                            
                                                                    
                                } 
                        }
                    }

                    //Code for PAWN
            }

        }

        function MovePiece(target, endFile, endRank) {
            // Change the tile that the piece points to.
            // Old tile should dereference the piece.
            // New tile should reference piece.
            // No need to return anything.

            let tempRank = target.getRank;
            let tampFile = target.getFile;

            target.setRank = endRank;
            target.setFile = endFile;

            board.tilemap[tempFile][tempRank].setPiece = null;
            board.tilemap[endFile][endRank].setPiece = target;


            return;
        }

    </script>
</body>
</html>